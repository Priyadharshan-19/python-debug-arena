{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">

<div class="max-w-7xl mx-auto px-4 py-8 flex flex-col h-[85vh]">

    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-6">
            <h2 class="text-2xl font-bold text-white">
                {{ level.title }}
                <span class="text-sm text-slate-500 font-normal">(Level {{ level_id }})</span>
            </h2>

            <div class="flex items-center gap-2 bg-slate-900 px-4 py-2 rounded-xl border border-slate-800">
                <span class="text-slate-500 text-xs font-bold uppercase tracking-widest">Elapsed</span>
                <span id="timer-display" class="text-blue-400 font-mono font-bold text-lg">00:00</span>
            </div>
        </div>

        <div class="flex gap-4">
            <button id="hint-btn"
                onclick="showHint()"
                class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-bold transition">
                üí° Get Hint
            </button>

            <button onclick="submitCode()"
                class="px-6 py-2 bg-green-600 hover:bg-green-500 text-slate-900 font-bold rounded-lg transition shadow-lg shadow-green-500/20">
                üöÄ Run & Submit
            </button>
        </div>
    </div>

    <div id="hint-box"
         class="hidden mt-4 p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
        <div class="flex items-center gap-2 mb-2">
            <span class="text-blue-400 font-bold text-xs uppercase tracking-widest">
                üí° System Intelligence Hint
            </span>
        </div>
        <p id="hint-text" class="text-slate-300 text-sm italic"></p>
        <p class="text-[10px] text-red-400 mt-2 font-bold uppercase tracking-tighter">
            * Penalty Applied to Level Score
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow overflow-hidden mt-4">

        <div class="rounded-2xl border border-slate-800 overflow-hidden bg-[#282a36]">
            <textarea id="code-editor">{{ level.buggy_code }}</textarea>
        </div>

        <div class="flex flex-col gap-4">

            <div class="flex-grow bg-[#020617] rounded-2xl border border-slate-800 p-6 mono text-sm overflow-y-auto">
                <div class="text-slate-500 mb-2 uppercase text-xs tracking-widest font-bold">
                    Terminal Output
                </div>
                <div id="console" class="text-slate-300">
                    Waiting for execution...
                </div>
            </div>

            <div class="h-1/3 bg-slate-900/50 rounded-2xl border border-slate-800 p-6">
                <div class="text-slate-500 mb-2 uppercase text-xs tracking-widest font-bold">
                    Goal
                </div>
                <p class="text-slate-300 text-sm">
                    Correct the code to produce exactly:<br>
                    <span class="text-green-400 font-mono">
                        {{ level.expected_output }}
                    </span>
                </p>
            </div>
        </div>
    </div>
</div>

<div id="success-modal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-950/80 backdrop-blur-sm px-4">
    <div class="bg-slate-900 border border-green-500/30 p-8 rounded-3xl max-w-sm w-full text-center
                shadow-[0_0_50px_-12px_rgba(34,197,94,0.5)]">

        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-slate-900" fill="none" stroke="currentColor"
                 viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                      d="M5 13l4 4L19 7"></path>
            </svg>
        </div>

        <h2 class="text-3xl font-black text-white mb-2">Level Cleared!</h2>
        <p class="text-slate-400 text-sm mb-8">
            System integrity restored. Your logic was flawless.
        </p>

        <a href="/dashboard"
            class="block w-full py-4 bg-green-600 hover:bg-green-500 text-slate-900 font-bold
                  rounded-xl transition-all active:scale-95 shadow-lg shadow-green-500/20">
            Return to Dashboard
        </a>
    </div>
</div>

<div id="hint-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-950/80 backdrop-blur-sm px-4">
    <div class="bg-slate-900 border border-blue-500/30 p-8 rounded-3xl max-w-sm w-full text-center shadow-[0_0_50px_-12px_rgba(59,130,246,0.5)]">
        <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="text-3xl">üí°</span>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Need a Hint?</h2>
        <p class="text-slate-400 text-sm mb-8">
            This will reveal the solution logic but will apply a **{{ level.penalty }} point penalty** to your score.
        </p>
        <div class="flex gap-4">
            <button onclick="closeHintModal()" class="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-xl transition">
                Cancel
            </button>
            <button onclick="confirmHint()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition shadow-lg shadow-blue-500/20">
                Reveal
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="{{ url_for('static', filename='js/proctor.js') }}"></script>

<script>
/* ---------------- PROCTORING CHECK ---------------- */
if ({{ team.violations }} >= 3) {
    window.location.href = "/disqualified";
}

/* ---------------- CODEMIRROR ---------------- */
const editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
    mode: "python",
    theme: "dracula",
    lineNumbers: true,
    indentUnit: 4,
    autoCloseBrackets: true
});

/* ---------------- AUDIO SYNTHESIZER ---------------- */
function playSuccessSound() {
    try {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const osc = context.createOscillator();
        const gain = context.createGain();
        
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(523.25, context.currentTime); // C5
        osc.frequency.exponentialRampToValueAtTime(1046.50, context.currentTime + 0.1); // C6
        
        gain.gain.setValueAtTime(0.1, context.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.3);
        
        osc.connect(gain);
        gain.connect(context.destination);
        
        osc.start();
        osc.stop(context.currentTime + 0.3);
    } catch (e) {
        console.log("Audio not supported or blocked by browser.");
    }
}

/* ---------------- TIMER ---------------- */
const timerEl = document.getElementById("timer-display");
const startTime = Date.now();

setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    timerEl.textContent = `${m}:${s}`;
}, 1000);

/* ---------------- SUBMIT CODE ---------------- */
async function submitCode() {
    const consoleEl = document.getElementById('console');
    consoleEl.innerText = "Running code...";

    const response = await fetch('/run_code/{{ level_id }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: editor.getValue() })
    });

    const data = await response.json();

    if (data.success) {
        playSuccessSound();
        const modal = document.getElementById('success-modal');
        const modalBtn = modal.querySelector('a');
        
        if ({{ level_id }} === 8) {
            modal.querySelector('h2').innerText = "Arena Conquered! üèÜ";
            modal.querySelector('p').innerText = "You have completed the final challenge. You are a Master Debugger.";
            modalBtn.innerText = "Claim Final Victory";
            modalBtn.href = "/victory";
            modalBtn.classList.replace('bg-green-600', 'bg-yellow-500');
        }
        
        modal.classList.remove('hidden');
        
        if (window.confetti) {
            confetti({ 
                particleCount: 150, 
                spread: 100, 
                origin: { y: 0.6 },
                colors: ['#22c55e', '#3b82f6', '#ffffff']
            });
        }
    } else {
        consoleEl.innerHTML = `
            <span class="text-red-400">‚úñ ${data.message}</span><br><br>
            <span class="text-slate-400">Output:</span><br>${data.output}
        `;
    }
}

/* ---------------- HINT SYSTEM ---------------- */

// 1. Open the custom modal
function showHint() {
    document.getElementById('hint-modal').classList.remove('hidden');
}

// 2. Close the modal if they cancel
function closeHintModal() {
    document.getElementById('hint-modal').classList.add('hidden');
}

// 3. The actual API call
async function confirmHint() {
    closeHintModal(); // Close the modal first
    
    const response = await fetch('/get_hint/{{ level_id }}', { method: 'POST' });
    const data = await response.json();

    if (data.success) {
        // Show the hint box in the arena
        document.getElementById('hint-box').classList.remove('hidden');
        document.getElementById('hint-text').innerText = data.hint;

        // Disable the hint button so they can't click it again
        const btn = document.getElementById('hint-btn');
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.innerHTML = "üí° Hint Revealed";
    } 
}
</script>

{% endblock %}